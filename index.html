<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–µ–ª—ë–Ω–∞—è –∫–∞—Ä—É—Å–µ–ª—å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="login-screen" class="center-screen">
    <h1>–ó–µ–ª—ë–Ω–∞—è –∫–∞—Ä—É—Å–µ–ª—å</h1>
    <form id="login-form">
      <label for="login-user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
      <select id="login-user"></select>
      <label for="login-pass">–ü–∞—Ä–æ–ª—å (4 —Ü–∏—Ñ—Ä—ã):</label>
      <input type="password" id="login-pass" maxlength="4" pattern="\d{4}" required />
      <button type="submit">–í–æ–π—Ç–∏</button>
    </form>
    <button id="register-user">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <div id="main-app" class="hidden">
    <header class="topbar">
      <h1>–ó–µ–ª—ë–Ω–∞—è –∫–∞—Ä—É—Å–µ–ª—å</h1>
      <div class="user-switch">
        <span id="current-user-label"></span>
        <button id="logout">–í—ã–π—Ç–∏</button>
      </div>
    </header>
    <nav class="tabs">
      <button class="tab active" data-target="plants">–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</button>
      <button class="tab" data-target="offers">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</button>
      <button class="tab" data-target="history">–ò—Å—Ç–æ—Ä–∏—è</button>
    </nav>
    <main>
      <!-- –†–∞—Å—Ç–µ–Ω–∏—è -->
      <section id="plants" class="tab-content active">
        <form id="add-plant-form" class="add-form">
          <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</h3>
          <input type="text" id="plant-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
          <select id="plant-type-add" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
            <option value="–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ">–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ</option>
            <option value="–°—É–∫–∫—É–ª–µ–Ω—Ç">–°—É–∫–∫—É–ª–µ–Ω—Ç</option>
            <option value="–î–æ–º–∞—à–Ω–µ–µ">–î–æ–º–∞—à–Ω–µ–µ</option>
            <option value="–°–∞–¥–æ–≤–æ–µ">–°–∞–¥–æ–≤–æ–µ</option>
          </select>
          <textarea id="plant-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
        <div class="filter-row">
          <label for="plant-type">–¢–∏–ø:</label>
          <select id="plant-type">
            <option value="">–í—Å–µ</option>
            <option value="–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ">–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ</option>
            <option value="–°—É–∫–∫—É–ª–µ–Ω—Ç">–°—É–∫–∫—É–ª–µ–Ω—Ç</option>
            <option value="–î–æ–º–∞—à–Ω–µ–µ">–î–æ–º–∞—à–Ω–µ–µ</option>
            <option value="–°–∞–¥–æ–≤–æ–µ">–°–∞–¥–æ–≤–æ–µ</option>
          </select>
          <button id="apply-filters">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <ul id="my-plants" class="list-style"></ul>
      </section>
      <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è -->
      <section id="offers" class="tab-content">
        <div id="exchange-offers" class="list-style"></div>
      </section>
      <!-- –ò—Å—Ç–æ—Ä–∏—è -->
      <section id="history" class="tab-content">
        <div id="exchange-history" class="list-style"></div>
      </section>
    </main>
  </div>

  <!-- –ù–æ–≤—ã–π —á–∞—Ç-–±–æ—Ç -->
  <div id="chat-container" class="chat-hidden" aria-live="polite">
    <div id="chat-header">
      <span>–ü–æ–º–æ—â–Ω–∏–∫ –ó–µ–ª—ë–Ω–æ–π –∫–∞—Ä—É—Å–µ–ª–∏</span>
      <button id="minimize-chat" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç">‚àí</button>
      <button id="close-chat" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">√ó</button>
    </div>
    <div id="chat-messages" role="log"></div>
    <!-- –ö–Ω–æ–ø–∫–∏ –∫–æ–º–∞–Ω–¥ -->
    <div class="command-buttons">
      <button data-command="/help">üìÑ –ü–æ–º–æ—â—å</button>
      <button data-command="/start">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</button>
      <button data-command="/plants">üå± –ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è</button>
      <button data-command="/exchange">üîÅ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω</button>
      <button data-command="/info">‚ÑπÔ∏è –û —Å–∞–π—Ç–µ</button>
    </div>
    <div id="chat-input-area">
      <input type="text" id="user-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." aria-label="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
      <button id="send-btn">‚û§</button>
    </div>
  </div>
  <div id="chat-toggle" role="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç-–ø–æ–º–æ—â–Ω–∏–∫">üí¨ –ü–æ–º–æ—â–Ω–∏–∫</div>

  <script src="script.js"></script>

  <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç-–±–æ—Ç–∞ -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const chatContainer = document.getElementById('chat-container');
      const chatToggle = document.getElementById('chat-toggle');
      const minimizeBtn = document.getElementById('minimize-chat');
      const closeBtn = document.getElementById('close-chat');
      const chatMessages = document.getElementById('chat-messages');
      const userInput = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');

      addBotMessage("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ –ó–µ–ª—ë–Ω–æ–π –∫–∞—Ä—É—Å–µ–ª–∏. –ú–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –æ–±–º–µ–Ω–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–π.");

      chatToggle.addEventListener('click', function () {
        chatContainer.classList.remove('chat-hidden');
        chatToggle.style.display = 'none';
        userInput.focus();
      });

      minimizeBtn.addEventListener('click', function () {
        chatContainer.classList.toggle('minimized');
        minimizeBtn.textContent = chatContainer.classList.contains('minimized') ? '+' : '‚àí';
      });

      closeBtn.addEventListener('click', function () {
        chatContainer.classList.add('chat-hidden');
        setTimeout(() => {
          chatToggle.style.display = 'block';
        }, 300);
      });

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        addUserMessage(message);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = '<span></span><span></span><span></span>';
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
        if (message.startsWith('/')) {
          let reply = '';
          switch (message.toLowerCase()) {
            case '/help':
              reply = `–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/help ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥\n/start ‚Äî –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n/plants ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è\n/exchange ‚Äî –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω\n/info ‚Äî –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∞–π—Ç–µ`;
              break;
            case '/start':
              reply = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ –ó–µ–ª—ë–Ω–æ–π –∫–∞—Ä—É—Å–µ–ª–∏. –ú–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –æ–±–º–µ–Ω–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–π.";
              break;
            case '/plants':
              fetchPlantsAndShow();
              chatMessages.removeChild(typingIndicator);
              return;
            case '/exchange':
              reply = "–ß—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω, –æ—Ç–∫—Ä–æ–π—Ç–µ —Ä–∞–∑–¥–µ–ª ¬´–ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è¬ª –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–º–µ–Ω¬ª —É –Ω—É–∂–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏—è.";
              break;
            case '/info':
              reply = "–ó–µ–ª—ë–Ω–∞—è –∫–∞—Ä—É—Å–µ–ª—å ‚Äî —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏. –¶–µ–ª—å ‚Äî –¥–µ–ª–∏—Ç—å—Å—è –∑–µ–ª–µ–Ω—å—é, –æ–ø—ã—Ç–æ–º –∏ —Ä–∞–¥–æ—Å—Ç—å—é!";
              break;
            default:
              reply = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.";
          }
          chatMessages.removeChild(typingIndicator);
          addBotMessage(reply);
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.focus();
          return;
        }

        try {
          const response = await fetch('https://api.deepinfra.com/v1/openai/chat/completions',  {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer hd2YqIvAP43FzTGEe4xeQUmTurAfYlCH"
            },
            body: JSON.stringify({
              model: "meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8",
              messages: [
                { role: "system", content: "–í—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã '–ó–µ–ª—ë–Ω–∞—è –∫–∞—Ä—É—Å–µ–ª—å'. –ü–æ–º–æ–≥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –æ–±–º–µ–Ω–æ–º —Ä–∞—Å—Ç–µ–Ω–∏–π, —Å–æ–≤–µ—Ç–∞–º–∏ –ø–æ —É—Ö–æ–¥—É –∏ –æ–±—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏." },
                { role: "user", content: message }
              ],
              temperature: 0.7,
              max_tokens: 500
            })
          });
          if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status}`);
          const data = await response.json();
          const botReply = data.choices[0].message.content;
          chatMessages.removeChild(typingIndicator);
          addBotMessage(botReply);
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ API:", error);
          chatMessages.removeChild(typingIndicator);
          addBotMessage("–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        } finally {
          userInput.disabled = false;
          sendBtn.disabled = false;
          userInput.focus();
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
      });

      function addUserMessage(text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message user-message';
        msgDiv.textContent = text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addBotMessage(text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message bot-message';
        const avatar = document.createElement('div');
        avatar.className = 'bot-avatar';
        avatar.textContent = 'üå±';
        const textContainer = document.createElement('div');
        textContainer.className = 'bot-text';
        textContainer.textContent = text;
        msgDiv.appendChild(avatar);
        msgDiv.appendChild(textContainer);
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // === –õ–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π –∏–∑ localStorage ===
      function fetchPlantsAndShow() {
        const STORAGE_KEY = 'greenCarouselData';
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
          plants: [],
          users: [],
          offers: [],
          history: []
        };

        const plants = data.plants;
        const myPlants = plants.filter(p => p.owner_id === CURRENT_USER_ID);

        if (myPlants.length === 0) {
          addBotMessage("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏–π.");
          return;
        }

        let plantList = "üå± –í–∞—à–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è:\n";
        myPlants.forEach((p, i) => {
          plantList += `${i + 1}. ${p.name} (${p.type}) ‚Äî ${p.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}\n`;
        });

        addBotMessage(plantList);
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º-–∫–æ–º–∞–Ω–¥–∞–º
      const commandButtons = document.querySelectorAll('.command-buttons button');
      commandButtons.forEach(button => {
        button.addEventListener('click', () => {
          const command = button.getAttribute('data-command');
          if (command) {
            userInput.value = command;
            sendMessage(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          }
        });
      });
    });
  </script>
</body>
</html>